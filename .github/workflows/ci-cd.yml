name: HealthBot CI/CD

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  smart-validation:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Install core dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flask python-dotenv colorama
        echo "âœ… Core dependencies installed"

    - name: List files for debugging
      run: |
        echo "ğŸ“ Current directory structure:"
        find . -name "*.py" -type f | head -20
        echo ""

    - name: Validate Python syntax
      run: |
        echo "ğŸ” Checking Python syntax..."
        # Check each file individually with better error handling
        for file in app.py health_alerts.py kafka_service.py register_user.py; do
          if [ -f "$file" ]; then
            echo "Checking $file..."
            python -m py_compile "$file" && echo "âœ… $file syntax OK" || exit 1
          else
            echo "âš ï¸  $file not found, skipping"
          fi
        done
        echo "âœ… Python syntax validation completed!"

    - name: Test basic imports
      run: |
        echo "ğŸ“¦ Testing imports..."
        python -c "
        try:
            import flask
            print('âœ… Flask OK')
        except Exception as e:
            print(f'âŒ Flask failed: {e}')
            exit(1)
            
        try:
            from dotenv import load_dotenv
            print('âœ… dotenv OK')
        except Exception as e:
            print(f'âŒ dotenv failed: {e}')
            exit(1)
            
        try:
            import colorama
            print('âœ… Colorama OK')
        except Exception as e:
            print(f'âŒ Colorama failed: {e}')
            exit(1)
        "
        echo "âœ… All core imports work!"

    - name: Check for required files
      run: |
        echo "ğŸ“‹ Checking required files..."
        [ -f "app.py" ] && echo "âœ… app.py exists" || echo "âŒ app.py missing"
        [ -f "requirements.txt" ] && echo "âœ… requirements.txt exists" || echo "âŒ requirements.txt missing"
        [ -f ".env.example" ] && echo "âœ… .env.example exists" || echo "âš ï¸  .env.example not found (optional)"

    - name: HealthBot Ready
      run: |
        echo "ğŸ‰ HEALTHBOT VALIDATION PASSED!"
        echo "âœ… Code syntax: Valid"
        echo "âœ… Core imports: Working" 
        echo "âœ… Dependencies: Installed"
        echo "ğŸš€ Ready for development!"